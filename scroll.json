WITH scroll_daily_txs AS (
  SELECT
    DATE_TRUNC('day', block_time) AS "date",
    SUM(TRY_CAST("value" AS DOUBLE) / 1e18) AS eth_total,
    COUNT(DISTINCT "from") AS unique_users,
    COUNT(*) AS daily_transactions
  FROM ethereum.traces
  WHERE
    to = 0xF8B1378579659D8F7EE5f3C929c2f3E332E41Fd6
    AND TRY_CAST("value" AS DOUBLE) > 0
    AND "success" = TRUE
  GROUP BY
    DATE_TRUNC('day', block_time)
), eth_price AS (
  SELECT
    price AS eth_price_usd
  FROM prices.usd
  WHERE
    symbol = 'ETH' AND minute < CURRENT_TIMESTAMP - INTERVAL '1' hour
  ORDER BY
    minute DESC
  FETCH FIRST 1 ROWS ONLY
)
SELECT
  SUM(1) OVER (
    ORDER BY
      sdt."date"
  ) AS days_nr,
  sdt."date",
  sdt.eth_total,
  sdt.unique_users,
  sdt.daily_transactions,
  SUM(sdt.eth_total) OVER (ORDER BY sdt."date") AS cumulative_eth_total,
  SUM(sdt.unique_users) OVER (ORDER BY sdt."date") AS cumulative_users,
  SUM(sdt.daily_transactions) OVER (ORDER BY sdt."date") AS cumulative_transactions,
  sdt.eth_total * ep.eth_price_usd AS eth_total_usd,
SUM(sdt.eth_total) OVER (ORDER BY sdt."date") * ep.eth_price_usd AS cumulative_eth_total_usd
FROM scroll_daily_txs AS sdt
JOIN eth_price AS ep
  ON 1 = 1
ORDER BY
  sdt."date" DESC;
